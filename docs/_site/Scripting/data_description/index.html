<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Spectroscopy HIstogram Visualizer for Event Reduction | a data visualization tool for single crystal neutron spectroscopy.</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Spectroscopy HIstogram Visualizer for Event Reduction" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="a data visualization tool for single crystal neutron spectroscopy." />
<meta property="og:description" content="a data visualization tool for single crystal neutron spectroscopy." />
<link rel="canonical" href="http://localhost:4000/Shiver/Scripting/data_description/" />
<meta property="og:url" content="http://localhost:4000/Shiver/Scripting/data_description/" />
<meta property="og:site_name" content="Spectroscopy HIstogram Visualizer for Event Reduction" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Spectroscopy HIstogram Visualizer for Event Reduction" />
<script type="application/ld+json">
{"url":"http://localhost:4000/Shiver/Scripting/data_description/","headline":"Spectroscopy HIstogram Visualizer for Event Reduction","@type":"WebPage","description":"a data visualization tool for single crystal neutron spectroscopy.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" as="style" type="text/css" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/Shiver/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/Shiver/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <a id="skip-to-content" href="#content">Skip to the content.</a>

    <header class="page-header" role="banner">
      <h1 class="project-name">SHIVER - <u>S</u>pectroscopy <u>HI</u>stogram <u>V</u>isualizer for <u>E</u>vent <u>R</u>eduction</h1>
      
      
      
    </header>
    
    <main id="content" class="main-content" role="main">
    <a href=/Shiver/>Home</a>
      <ul id="markdown-toc">
  <li><a href="#data-description" id="markdown-toc-data-description">Data Description</a></li>
  <li><a href="#mandatory-parameters" id="markdown-toc-mandatory-parameters">Mandatory parameters</a>    <ul>
      <li><a href="#runs" id="markdown-toc-runs">Runs</a></li>
      <li><a href="#rawdatafolder" id="markdown-toc-rawdatafolder">RawDataFolder</a></li>
      <li><a href="#mdename" id="markdown-toc-mdename">MdeName</a></li>
      <li><a href="#mdefolder" id="markdown-toc-mdefolder">MdeFolder</a></li>
      <li><a href="#normalizationdatafile" id="markdown-toc-normalizationdatafile">NormalizationDataFile</a></li>
      <li><a href="#maskingdatafile" id="markdown-toc-maskingdatafile">MaskingDataFile</a></li>
    </ul>
  </li>
  <li><a href="#additional-parameters" id="markdown-toc-additional-parameters">Additional parameters</a>    <ul>
      <li><a href="#backgroundmdename" id="markdown-toc-backgroundmdename">BackgroundMdeName</a></li>
      <li><a href="#backgroundruns" id="markdown-toc-backgroundruns">BackgroundRuns</a></li>
      <li><a href="#backgroundscaling" id="markdown-toc-backgroundscaling">BackgroundScaling</a></li>
      <li><a href="#backgroundrawdatafolder" id="markdown-toc-backgroundrawdatafolder">BackgroundRawDataFolder</a></li>
      <li><a href="#ubsetup" id="markdown-toc-ubsetup">UBSetup</a></li>
    </ul>
  </li>
  <li><a href="#overriding-default-reduction-parameters" id="markdown-toc-overriding-default-reduction-parameters">Overriding default reduction parameters</a>    <ul>
      <li><a href="#ei" id="markdown-toc-ei">Ei</a></li>
      <li><a href="#t0" id="markdown-toc-t0">T0</a></li>
      <li><a href="#samplelogvariables" id="markdown-toc-samplelogvariables">SampleLogVariables</a></li>
      <li><a href="#badpulsesthreshold" id="markdown-toc-badpulsesthreshold">BadPulsesThreshold</a></li>
      <li><a href="#timeindepbackgroundwindow" id="markdown-toc-timeindepbackgroundwindow">TimeIndepBackgroundWindow</a></li>
      <li><a href="#e_min" id="markdown-toc-e_min">E_min</a></li>
      <li><a href="#e_max" id="markdown-toc-e_max">E_max</a></li>
      <li><a href="#additionaldimensions" id="markdown-toc-additionaldimensions">AdditionalDimensions</a></li>
    </ul>
  </li>
  <li><a href="#polarization-related-parameters" id="markdown-toc-polarization-related-parameters">Polarization related parameters</a>    <ul>
      <li><a href="#polarizationstate" id="markdown-toc-polarizationstate">PolarizationState</a></li>
      <li><a href="#flippingratio" id="markdown-toc-flippingratio">FlippingRatio</a></li>
      <li><a href="#polarizingsupermirrordeflectionadjustment" id="markdown-toc-polarizingsupermirrordeflectionadjustment">PolarizingSupermirrorDeflectionAdjustment</a></li>
      <li><a href="#efcorrectionfunction" id="markdown-toc-efcorrectionfunction">EfCorrectionFunction</a></li>
    </ul>
  </li>
</ul>

<h1 id="data-description">Data Description</h1>

<p>The purpose of this program is to transform time of flight event data into histograms in reciprocal space.
If one would like to look at more than one histogram of the same raw data, it would be computationally expensive to
repeat all the calculations. It is more efficient to preprocess data by applying various corrections, coordinate
transformations only once, and then store them in an intermediate data structure.
One of the <a href="/Shiver//Scripting/utility/">utility functions</a> to be called in the <a href="/Shiver//Scripting/main/">main program</a>
is taking care of this process. The only input parameter is a list of python dictionaries, each containing a
dataset description. This section will show the content of such a dictionary.</p>

<p>The minimal dataset decription can be generated in a function like:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="n">raw_data_folder</span><span class="o">=</span><span class="s">'/SNS/CNCS/IPTS-21407/nexus/'</span>
<span class="n">mde_folder</span><span class="o">=</span><span class="s">'/SNS/CNCS/IPTS-21407/shared/MDE/'</span>
<span class="n">vanadium_file</span> <span class="o">=</span> <span class="s">'/SNS/CNCS/IPTS-21407/shared/autoreduce/van_277537.nxs'</span>

<span class="k">def</span> <span class="nf">define_data_set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">data_set_list</span><span class="o">=</span><span class="p">[]</span>

    <span class="c1"># single dataset
</span>    <span class="n">data_set</span><span class="o">=</span><span class="p">{</span><span class="s">'Runs'</span><span class="p">:</span><span class="nb">range</span><span class="p">(</span><span class="mi">297517</span><span class="p">,</span><span class="mi">297696</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
              <span class="s">'RawDataFolder'</span><span class="p">:</span><span class="n">raw_data_folder</span><span class="p">,</span>
              <span class="s">'MdeFolder'</span><span class="p">:</span><span class="n">mde_folder</span><span class="p">,</span>
              <span class="s">'MdeName'</span><span class="p">:</span><span class="s">'merged_3K'</span><span class="p">,</span>
              <span class="s">'MaskingDataFile'</span><span class="p">:</span><span class="n">vanadium_file</span><span class="p">,</span>
              <span class="s">'NormalizationDataFile'</span><span class="p">:</span><span class="n">vanadium_file</span><span class="p">,</span>
              <span class="s">'UBSetup'</span><span class="p">:{</span><span class="s">'a'</span><span class="p">:</span><span class="mf">5.12484</span><span class="p">,</span><span class="s">'b'</span><span class="p">:</span><span class="mf">5.33161</span><span class="p">,</span><span class="s">'c'</span><span class="p">:</span><span class="mf">7.31103</span><span class="p">,</span>
                         <span class="s">'alpha'</span><span class="p">:</span><span class="mi">90</span><span class="p">,</span><span class="s">'beta'</span><span class="p">:</span><span class="mi">90</span><span class="p">,</span><span class="s">'gamma'</span><span class="p">:</span><span class="mi">90</span><span class="p">,</span>
                         <span class="s">'u'</span><span class="p">:</span><span class="s">'-0.0493617,4.27279,-4.37293'</span><span class="p">,</span>
                         <span class="s">'v'</span><span class="p">:</span><span class="s">'-0.0706905,-3.18894,-5.85775'</span><span class="p">},</span>
              <span class="p">}</span>
    <span class="n">data_set_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_set</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data_set_list</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>If you want to describe more datasets, just repeat the code between lines 8 and 21. Donâ€™t forget to append it to the list
of datasets.</p>

<h1 id="mandatory-parameters">Mandatory parameters</h1>

<h2 id="runs">Runs</h2>

<p>The <code class="language-python highlighter-rouge"><span class="n">Runs</span></code> are a list (or any iterable) of run numbers or a list of run numbers. Together with the <code class="language-python highlighter-rouge"><span class="n">RawDataFolder</span></code> parameter, 
these are describing what is the raw data. If the elements of the original list are
integers, say <code class="language-python highlighter-rouge"><span class="n">NNNN</span></code>, then the reduction will look in the raw data folder for the file <code class="language-python highlighter-rouge"><span class="o">*</span><span class="n">NNNN</span><span class="p">.</span><span class="n">nxs</span><span class="p">.</span><span class="n">h5</span></code>.</p>

<p>If the original iterable contains lists of runs, these will be added together for processing (assumed
to have the same sample orientation).</p>

<p>Here are a few examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1"># for runs 10, 11, 12, 13, 14
</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
<span class="c1"># for runs 100, 102, 105
</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">105</span><span class="p">]</span>
<span class="c1"># add together some ranges - this one is runs from 10 to 20, skipping 15
</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">21</span><span class="p">))</span>
<span class="c1"># add runs together for processing - runs separated by 10 have the same goniometer angle
</span><span class="p">[[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">],</span> <span class="p">[</span><span class="mi">101</span><span class="p">,</span><span class="mi">111</span><span class="p">],</span> <span class="p">[</span><span class="mi">102</span><span class="p">,</span> <span class="mi">112</span><span class="p">],</span> <span class="p">[</span><span class="mi">103</span><span class="p">,</span> <span class="mi">113</span><span class="p">],</span> <span class="p">[</span><span class="mi">104</span><span class="p">],</span> <span class="p">[</span><span class="mi">105</span><span class="p">]]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>In addition, we can store the run information in a json file. This is very useful if the <a href="https://oncat.ornl.gov">OnCat</a>
database is used. Using the <a href="/Shiver//Scripting/utility/">oncat utilites</a> functions, one generates a file, say
<code class="language-python highlighter-rouge"><span class="n">deleteme</span><span class="p">.</span><span class="n">json</span></code> with the following content:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"100meV_5K"</span><span class="p">:</span><span class="w"> </span><span class="p">[[</span><span class="mi">222204</span><span class="p">,</span><span class="w"> </span><span class="mi">222208</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">222205</span><span class="p">,</span><span class="w"> </span><span class="mi">222206</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">222207</span><span class="p">,</span><span class="w"> </span><span class="mi">222209</span><span class="p">]]}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>
<p>Then, the value of <code class="language-python highlighter-rouge"><span class="s">'Runs'</span></code> will be</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="s">'file'</span><span class="p">:</span><span class="s">'/SNS/some_path/deleteme.json'</span><span class="p">,</span> <span class="s">'ky'</span><span class="p">:</span><span class="s">"100meV_5K"</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="rawdatafolder">RawDataFolder</h2>

<p>The folder where the raw data (.nxs.h5) files are located.</p>

<h2 id="mdename">MdeName</h2>

<p>The name of the intermediate dataset. This is a <a href="https://mantidproject.org">Mantid</a> mutlidimensional event workspace.</p>

<p><strong>Note:</strong> Make sure each dataset has a unique name.</p>

<h2 id="mdefolder">MdeFolder</h2>

<p>The storage location for the intermediate dataset.</p>

<h2 id="normalizationdatafile">NormalizationDataFile</h2>

<p>This is a processed NeXus file that contains the efficiency/ solid angle measurement. It is usually
obtained by scattering from an incoherent scatterer, such as Vanadium or TiZr alloy. It will contain the same number
of spectra as the raw data, but it is integrated into a single bin (usually either energy or wavelength). It can contain
information about masking. At SNS, one can use the integrated Vanadium that is used for autoreduction.
It can be set to <code class="language-python highlighter-rouge"><span class="bp">None</span></code> if all detectors have the same efficiency.</p>

<h2 id="maskingdatafile">MaskingDataFile</h2>

<p>The masking data file is a Mantid procesed nexus file that contains information about masked data. In most
cases one can use the same file as the normalization data. It can also be set to <code class="language-python highlighter-rouge"><span class="bp">None</span></code>, in which case
the top and bottom eight pixels in each detector tube.</p>

<h1 id="additional-parameters">Additional parameters</h1>

<h2 id="backgroundmdename">BackgroundMdeName</h2>

<p>The name of the background intermediate data. Currently, two types of background butraction are implemented in this
program. In the first case, one can measure background at the same angles as the data (say a measurement at a different
temperature). In this case we process the background first, then use the <code class="language-python highlighter-rouge"><span class="n">MdeName</span></code> of the background dataset as
the <code class="language-python highlighter-rouge"><span class="n">BackgroundMdeName</span></code> for the current data. A second option would be to measure an isotropic background. In this cae,
the background runs must be specified.</p>

<h2 id="backgroundruns">BackgroundRuns</h2>

<p>This is a list of runs to be added together and processed as a single background.</p>

<h2 id="backgroundscaling">BackgroundScaling</h2>

<p>When one subtracts a background, one might need to rescale it (different amount of background). By default, the scaling factor is 1.</p>

<h2 id="backgroundrawdatafolder">BackgroundRawDataFolder</h2>

<p>The location for the raw background files. If not entered, it will be the same as the <code class="language-python highlighter-rouge"><span class="n">RawDataFolder</span></code></p>

<h2 id="ubsetup">UBSetup</h2>

<p>For convenience, one can save the sample lattice parameters and orientation using the UB matrix formalism. The
value of this parameter is a dictionary containing the input parameters for the
<a href="https://docs.mantidproject.org/nightly/algorithms/SetUB-v1.html">SetUB</a> Mantid algorithm (with the except of <code class="language-python highlighter-rouge"><span class="n">InputWorkspace</span></code>).</p>

<h1 id="overriding-default-reduction-parameters">Overriding default reduction parameters</h1>

<p>The program will try to guess the correct reduction parameters, but it might get the wrong values in some cases.
It is advisable to consult the instrument scientist before modifying any of these values.
Here are some inputs that can be set by the user:</p>

<h2 id="ei">Ei</h2>

<p>The incident energy in meV.</p>

<h2 id="t0">T0</h2>

<p>The time zero offset (the nominal time when the neutrons leave the moderator face).</p>

<h2 id="samplelogvariables">SampleLogVariables</h2>

<p>Some additional sample logs might be required to reduce the data. The value of this parameter is a dictionary.
Currently only the following keys are processed:</p>

<ul>
  <li><code class="language-python highlighter-rouge"><span class="s">'OmegaMotorName'</span></code>: a string that contains the name of the motor for sample rotation around the vertical axis.
If set to <code class="language-python highlighter-rouge"><span class="bp">None</span></code>, the default the goniometer setting is found from the <code class="language-python highlighter-rouge"><span class="n">phi</span></code>, <code class="language-python highlighter-rouge"><span class="n">chi</span></code>, and <code class="language-python highlighter-rouge"><span class="n">omega</span></code> sample logs, but for some older
files one might need to use something like <code class="language-python highlighter-rouge"><span class="s">'huber'</span></code> or <code class="language-python highlighter-rouge"><span class="s">'CCR13VRot'</span></code>. Consult with the instrument scientist.</li>
  <li><code class="language-python highlighter-rouge"><span class="s">'Temperature'</span></code>: The temperature (in Kelvin) of the sample. It can be a number or a string containing the sample log corresponding
to the temperature. This is only used to calculate the dynamic susceptibility (apply the detailed balance).</li>
</ul>

<h2 id="badpulsesthreshold">BadPulsesThreshold</h2>

<p>If one wants to filter out events with low proton charge (during the ramping of the accelerator), this input
is used by the <a href="https://docs.mantidproject.org/nightly/algorithms/FilterBadPulses-v1.html">FilterBadPulses</a>
algorithm. By default it is <code class="language-python highlighter-rouge"><span class="bp">None</span></code>.</p>

<h2 id="timeindepbackgroundwindow">TimeIndepBackgroundWindow</h2>

<p>This parameter allows a time independent background subtraction. The following options are allowed:</p>
<ul>
  <li><code class="language-python highlighter-rouge"><span class="bp">None</span></code> - no time independent bakckground.</li>
  <li><code class="language-python highlighter-rouge"><span class="s">'Default'</span></code> - for CNCS and HYSPEC instruments there are Mantid algorithms to guess and independent
background range, based on incident energy. There is no processing done for other instruments</li>
  <li><code class="language-python highlighter-rouge"><span class="p">[</span><span class="n">TIB_min</span><span class="p">,</span> <span class="n">TIB_max</span><span class="p">]</span></code> - a list with the time independent background range in units of microseconds. Consult your local
contact for adequate values.</li>
</ul>

<h2 id="e_min">E_min</h2>

<p>The lower end of energy transfer to be processed, in units of meV. If set to <code class="language-python highlighter-rouge"><span class="bp">None</span></code> the program will use -0.95 times the
incident energy.</p>

<h2 id="e_max">E_max</h2>

<p>The upper end of energy transfer to be processed, in units of meV. If set to <code class="language-python highlighter-rouge"><span class="bp">None</span></code> the program will use +0.95 times the
incident energy.</p>

<h2 id="additionaldimensions">AdditionalDimensions</h2>

<p>By default the intermediate data is stored as a muti-dimensional workspace. The coordinates are momentum transfer in the
sampel coordinate frame and energy transfer. This parameter allows adding additional dimensions (such as temperature).
Each additional dimension is a triplet. The first element of the triplet is the sample log variable name, the
second and third are the minimum and maximum values to be used. For example, set <code class="language-python highlighter-rouge"><span class="s">'AdditionalDimensions'</span></code> to:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">[(</span><span class="s">'SampleTemp'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">)]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="polarization-related-parameters">Polarization related parameters</h1>

<h2 id="polarizationstate">PolarizationState</h2>

<p>This is a label for polarization state, such as <code class="language-python highlighter-rouge"><span class="s">'SF_Px'</span><span class="p">;</span><span class="s">'NSF_Px'</span><span class="p">;</span><span class="s">'SF_Py'</span><span class="p">;</span><span class="s">'NSF_Py'</span><span class="p">;</span><span class="s">'SF_Pz'</span><span class="p">;</span><span class="s">'NSF_Pz'</span></code>. It is not
directly used by the program. It is intended for future expansion to calculate nuclear, magnetic, and
incoherent cross sections for polarized experiments.</p>

<h2 id="flippingratio">FlippingRatio</h2>

<p>A number or a mathematical expression involving certain sample environment parameters, that allows corrections
for flipping ratio. For details see <a href="https://docs.mantidproject.org/nightly/algorithms/FlippingRatioCorrectionMD-v1.html">FlippingRatioCorrectionMD</a>
algorithm. For example, setting this value to</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="s">'6.5+2.8*cos((omega+3.7)*pi/180),omega'</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>will generate a flipping ratio that is dependent on the <code class="language-python highlighter-rouge"><span class="n">omega</span></code> value in the raw files.</p>

<h2 id="polarizingsupermirrordeflectionadjustment">PolarizingSupermirrorDeflectionAdjustment</h2>

<p>In case that the sample log specifying that a run is measured in polarized mode is not correctly recorded in the file,
set this value to <code class="language-python highlighter-rouge"><span class="mi">0</span></code> for unpolarized measurements or <code class="language-python highlighter-rouge"><span class="o">-</span><span class="mf">1.8</span></code> for polarized experiments on HYSPEC.</p>

<h2 id="efcorrectionfunction">EfCorrectionFunction</h2>

<p>This is the name of a function to apply to the data. Currently it is used to provide a correction for the transmission of the supermirror analyzer on HYSPEC. However, any function can be implemented, with a signature that takes a workspace handle and a data description. The input workspace of this function will be an event workspace, in units of energy transfer (just before converting to a multi-dimensional event workspace).</p>


      <footer class="site-footer">
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>
  </body>
</html>
