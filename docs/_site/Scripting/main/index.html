<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Spectroscopy HIstogram Visualizer for Event Reduction | a data visualization tool for single crystal neutron spectroscopy.</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Spectroscopy HIstogram Visualizer for Event Reduction" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="a data visualization tool for single crystal neutron spectroscopy." />
<meta property="og:description" content="a data visualization tool for single crystal neutron spectroscopy." />
<link rel="canonical" href="http://localhost:4000/Shiver/Scripting/main/" />
<meta property="og:url" content="http://localhost:4000/Shiver/Scripting/main/" />
<meta property="og:site_name" content="Spectroscopy HIstogram Visualizer for Event Reduction" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Spectroscopy HIstogram Visualizer for Event Reduction" />
<script type="application/ld+json">
{"url":"http://localhost:4000/Shiver/Scripting/main/","headline":"Spectroscopy HIstogram Visualizer for Event Reduction","@type":"WebPage","description":"a data visualization tool for single crystal neutron spectroscopy.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" as="style" type="text/css" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/Shiver/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/Shiver/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <a id="skip-to-content" href="#content">Skip to the content.</a>

    <header class="page-header" role="banner">
      <h1 class="project-name">SHIVER - <u>S</u>pectroscopy <u>HI</u>stogram <u>V</u>isualizer for <u>E</u>vent <u>R</u>eduction</h1>
      
      
      
    </header>
    
    <main id="content" class="main-content" role="main">
    <a href=/Shiver/>Home</a>
      <ul id="markdown-toc">
  <li><a href="#main-program" id="markdown-toc-main-program">Main program</a>    <ul>
      <li><a href="#import-section" id="markdown-toc-import-section">Import section</a></li>
      <li><a href="#getting-the-data" id="markdown-toc-getting-the-data">Getting the data</a></li>
      <li><a href="#generating-slices" id="markdown-toc-generating-slices">Generating slices</a></li>
      <li><a href="#plotting-slices" id="markdown-toc-plotting-slices">Plotting slices</a></li>
      <li><a href="#notes-about-polarization" id="markdown-toc-notes-about-polarization">Notes about polarization</a></li>
    </ul>
  </li>
</ul>

<h1 id="main-program">Main program</h1>

<p>The purpose of the main program is to load the data and slice definitions, generate or load the intermediate multidimensional
event workspaces, and create the required histograms. Usually one would also plot any one or two dimensional slices using
matplotlib.</p>

<p>A simple script would look something like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">imp</span> <span class="kn">import</span> <span class="nb">reload</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'/opt/Mantid/bin'</span><span class="p">)</span>
<span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'/opt/Mantid/lib'</span><span class="p">)</span>
<span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'/SNS/groups/dgs/DGS_SC_scripts'</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">mantid</span> <span class="kn">import</span> <span class="n">plots</span>
<span class="kn">from</span> <span class="nn">reduce_data_to_MDE</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">slice_utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">define_data_example</span>
<span class="kn">import</span> <span class="nn">define_slices_example</span>

<span class="c1">#############################################
# MAIN PROGRAM
#############################################
</span><span class="nb">reload</span><span class="p">(</span><span class="n">define_data_example</span><span class="p">)</span>
<span class="nb">reload</span><span class="p">(</span><span class="n">define_slices_example</span><span class="p">)</span>

<span class="n">datasets</span><span class="o">=</span><span class="n">define_data_example</span><span class="p">.</span><span class="n">define_data_set</span><span class="p">()</span>
<span class="n">reduce_data_to_MDE</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>

<span class="n">slice_descriptions</span><span class="o">=</span><span class="n">define_slices_example</span><span class="p">.</span><span class="n">define_data_slices</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="s">'_dataset0'</span><span class="p">)</span>

<span class="n">make_slice</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">slice_descriptions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s">'projection'</span><span class="p">:</span><span class="s">'mantid'</span><span class="p">})</span>
<span class="n">c</span><span class="o">=</span><span class="n">plot_slice</span><span class="p">(</span><span class="n">slice_descriptions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cbar_label</span><span class="o">=</span><span class="s">'Intensity'</span><span class="p">)</span>
<span class="n">set_axes_parameters</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="o">**</span><span class="n">slice_descriptions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">'Axes_parameters'</span><span class="p">])</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="import-section">Import section</h2>

<p>This is lines 1-12 in the above example. Since the program uses Mantid as the main processing
library, one might add it to the <code class="language-python highlighter-rouge"><span class="n">sys</span><span class="p">.</span><span class="n">path</span></code> (lines 3-5). You might ommit these if you run
this script from within a Mantid environment (mantidpython or MantidWorkbench). Similarly,
the location of the utlility functions called in this program needs to be available (line 6).
You can skip this information if you already added this files to your python path, or if they
are in the same folder as the current script.</p>

<p>We need to import the following libraries:</p>

<ul>
  <li><code class="language-python highlighter-rouge"><span class="n">reduce_data_to_MDE</span></code> - utility library to load/ process the raw data to <code class="language-python highlighter-rouge"><span class="n">MDEventWorkspace</span></code></li>
  <li><code class="language-python highlighter-rouge"><span class="n">slice_utils</span></code> - library to generate slices (and optionally plot them)</li>
  <li>Your data description, <code class="language-python highlighter-rouge"><span class="n">define_data_example</span></code> in this case</li>
  <li>Your slice description, <code class="language-python highlighter-rouge"><span class="n">define_slices_example</span></code> in this case</li>
  <li>Optionally the <code class="language-python highlighter-rouge"><span class="n">mantid</span><span class="p">.</span><span class="n">plots</span></code> library, in case you want to use matplotlib to plot your data</li>
</ul>

<p>One might run the program multiple times, just changing data or slice descriptions. Since those
functions are in libraries already loaded in python, just running <code class="language-python highlighter-rouge"><span class="k">import</span></code> again will not get the
latest updates. For that one must force reload the libraries (lines 17 and 18).</p>

<h2 id="getting-the-data">Getting the data</h2>

<p>To get the data, the first step is to get the corresponding definitions. This is achieved using
a call to the user defined <a href="/Shiver//Scripting/data_description/">data description</a>, in line 20.
The <a href="/Shiver//Scripting/utility/#reduce-raw-data-to-mdevent-workspaces">reduce_data_to_MDE</a> function (line 21)
takes the list of data descriptions and makes sure that, for each description, the workspace with the given <code class="language-python highlighter-rouge"><span class="n">MDEName</span></code> is present
in memory. Optionally, if the <code class="language-python highlighter-rouge"><span class="n">BackgroundMdeName</span></code> is not <code class="language-python highlighter-rouge"><span class="bp">None</span></code>, it will also get those workspaces.</p>

<p><strong>Note:</strong> Since the generation of the intermediate <code class="language-python highlighter-rouge"><span class="n">MDEvent</span></code> data structure is slow, the behavior of
the <code class="language-python highlighter-rouge"><span class="n">reduce_data_to_MDE</span></code> function is as follows</p>
<ul>
  <li>If there is a workspace in memory with the name <code class="language-python highlighter-rouge"><span class="n">MDEName</span></code> no further processing will happen</li>
  <li>If the <code class="language-python highlighter-rouge"><span class="n">MDEName</span></code> workspace is not in memory, it will try it to load it from the file with the same
name, extension <code class="language-python highlighter-rouge"><span class="p">.</span><span class="n">nxs</span></code>, in the <code class="language-python highlighter-rouge"><span class="n">MdeFolder</span></code></li>
  <li>If the above steps fail, the function will try to generate the workspace from the parameters given
in the data description.</li>
</ul>

<p>A similar behavior is present for the background data. In the case one would like to re-reduce the original data,
then one would need to delete the workspace from memory <em>and</em> delete it from the disk.</p>

<h2 id="generating-slices">Generating slices</h2>

<p>Similar to getting the data, generating slices is a two step process. In the first step, a call (line 23) to
the userdefined slice description library returns a list of dictionaries, one for each slice. If more
than one dataset is to be cut, it is recommended to use the <code class="language-python highlighter-rouge"><span class="n">extra</span></code> parameter to generate a new set of
slice descriptions for each dataset, so that the names of the histogrammed workspaces are different.</p>

<p>The second step is to generate the histogram (1D, 2D, 3D, …). This is done using the
<a href="/Shiver//Scripting/utility/#generating-histograms">make_slice</a> function (line 25). The main
parameters are a single dataset description and a single slice description. Most of the calculation is
done using the <a href="https://docs.mantidproject.org/nightly/algorithms/MDNorm-v1.html">MDNorm</a> algorithm.
Additional parameters allow for overriding the measured efficiency workspace (usually Vanadium), and for
saving the data in ASCII or HDF5 file (processed MD histogram workspace in Mantid).</p>

<p>The main result is the generation of an MDHistogram workspace with the name given in the slice description.</p>

<h2 id="plotting-slices">Plotting slices</h2>

<p>Optionally, one can plot the histograms as part of this script. One can use the
<a href="https://docs.mantidproject.org/nightly/plotting/index.html#plotting">Mantid/matplotlib</a>
libraries. For convenience, a <a href="/Shiver//Scripting/utility/#plotting-functions">plot_slice</a>
function can be used for line plots (wrapping a call to matplotlib errorbar function), or for 2D
plots (using matplotlib pcolormesh and colorbar functions). The example in the script above will
generate a 2D plot on the screen.</p>

<h2 id="notes-about-polarization">Notes about polarization</h2>

<p>For polarized mode, one would like to apply a flipping ratio correction to the data. This
needs to account for both the spin flip and non spin flip data. For convenience, a
<code class="language-python highlighter-rouge"><span class="n">make_slices_FR_corrected</span></code> function is available. It uses two datasets, it applies the
flipping ratio corrections, and it will use the <code class="language-python highlighter-rouge"><span class="n">make_slice</span></code> function to produce
histograms for both spin states.</p>


      <footer class="site-footer">
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>
  </body>
</html>
